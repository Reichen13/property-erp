# 管理员操作手册 - 系统更新与数据安全

## 概述

本手册指导管理员在系统上线后如何安全地进行功能更改和UI样式修改，确保已录入的数据不会丢失或混乱。

---

## 一、代码更改与数据的关系

### 不会影响数据的更改（安全操作）

| 更改类型 | 示例 | 风险等级 |
|----------|------|----------|
| UI样式修改 | 颜色、布局、字体、间距 | 无风险 |
| 页面文字修改 | 标题、提示语、按钮文字 | 无风险 |
| 新增功能页面 | 添加新的报表、新的查询功能 | 低风险 |
| 修改业务逻辑 | 计算方式、验证规则（不涉及数据库结构） | 低风险 |
| 修改报表展示 | 图表样式、数据格式化 | 无风险 |

### 可能影响数据的更改（需谨慎操作）

| 更改类型 | 示例 | 风险等级 |
|----------|------|----------|
| 修改数据库表结构 | 增删改字段 | 高风险 |
| 修改数据模型 | `models/entities.py` 中的类定义 | 高风险 |
| 删除数据库字段 | 移除现有字段 | 极高风险 |
| 重命名数据库字段 | 更改字段名称 | 极高风险 |

---

## 二、更改前必做：备份数据库

### 方法1：命令行备份（推荐）

```bash
# 进入项目目录
cd /home/ubuntu/erp

# 创建带时间戳的备份
cp property_erp_1.7.1.db backups/property_erp_$(date +%Y%m%d_%H%M%S).db

# 验证备份
ls -la backups/
```

### 方法2：系统内备份

1. 登录系统（管理员账号）
2. 进入：**报表与备份 → 数据备份**
3. 点击：**立即备份**
4. 确认备份成功提示

### 备份文件位置

```
/home/ubuntu/erp/backups/
├── property_erp_20260113.db      # 自动备份
├── property_erp_20260114.db      # 自动备份
└── property_erp_backup_*.db      # 手动备份
```

---

## 三、不同类型更改的操作流程

### 流程A：UI样式/文字修改（无风险）

```
1. 直接修改代码文件
   ↓
2. 重启服务
   ↓
3. 验证修改效果
```

**示例：修改页面标题**
```python
# 修改 erp_modular/pages/dashboard.py
st.title("📊 运营驾驶舱")  # 修改这里的文字
```

### 流程B：新增功能（低风险）

```
1. 备份数据库
   ↓
2. 编写新功能代码
   ↓
3. 重启服务
   ↓
4. 测试新功能
   ↓
5. 验证原有数据完整
```

### 流程C：修改业务逻辑（中风险）

```
1. 备份数据库
   ↓
2. 记录当前数据量（房产数、账单数等）
   ↓
3. 修改代码
   ↓
4. 重启服务
   ↓
5. 测试修改后的功能
   ↓
6. 核对数据量是否一致
   ↓
7. 验证核心功能正常
```

### 流程D：修改数据库结构（高风险）

```
1. 备份数据库（必须！）
   ↓
2. 导出关键数据到CSV
   ↓
3. 编写数据迁移脚本
   ↓
4. 在测试环境验证
   ↓
5. 停止生产服务
   ↓
6. 执行数据迁移
   ↓
7. 启动服务
   ↓
8. 全面验证数据
```

---

## 四、重启服务的正确方式

### 停止服务

```bash
sudo systemctl stop property-erp
```

### 启动服务

```bash
sudo systemctl start property-erp
```

### 查看服务状态

```bash
sudo systemctl status property-erp
```

### 查看服务日志

```bash
# 查看最近日志
journalctl -u property-erp -n 50

# 实时查看日志
journalctl -u property-erp -f
```

### 一键重启

```bash
sudo systemctl restart property-erp
```

---

## 五、修改数据库结构的安全方法

### 添加新字段（推荐方式）

使用 `ALTER TABLE` 添加字段，不会丢失现有数据：

```sql
-- 连接数据库
sqlite3 property_erp_1.7.1.db

-- 添加新字段（设置默认值）
ALTER TABLE rooms ADD COLUMN new_field TEXT DEFAULT '';

-- 添加新字段（允许为空）
ALTER TABLE bills ADD COLUMN extra_info TEXT;

-- 验证字段已添加
.schema rooms
```

### 同步修改数据模型

在 `models/entities.py` 中添加对应字段：

```python
class Room(Base):
    # ... 现有字段 ...
    new_field = Column(String, default='')  # 新增字段
```

### 禁止的操作

❌ **不要直接删除数据库文件**
```bash
# 错误！会丢失所有数据！
rm property_erp_1.7.1.db
```

❌ **不要使用 DROP TABLE**
```sql
-- 错误！会丢失表中所有数据！
DROP TABLE rooms;
```

❌ **不要重建表结构**
```sql
-- 错误！会丢失数据！
DROP TABLE bills;
CREATE TABLE bills (...);
```

---

## 六、数据安全检查清单

### 更改前检查

- [ ] 已备份数据库文件
- [ ] 已记录当前数据量
  - 房产数量：____
  - 账单数量：____
  - 收款记录数：____
- [ ] 如涉及数据库结构，已准备迁移脚本
- [ ] 已在测试环境验证（如有）

### 更改后检查

- [ ] 服务正常启动（无报错）
- [ ] 可以正常登录系统
- [ ] 数据量与更改前一致
- [ ] 核心功能正常：
  - [ ] 收银台可以正常收款
  - [ ] 账单可以正常查询
  - [ ] 报表可以正常显示
- [ ] 审计日志正常记录

---

## 七、数据恢复方法

### 从备份恢复

```bash
# 1. 停止服务
sudo systemctl stop property-erp

# 2. 备份当前（可能损坏的）数据库
mv property_erp_1.7.1.db property_erp_1.7.1.db.broken

# 3. 恢复备份
cp backups/property_erp_20260114.db property_erp_1.7.1.db

# 4. 启动服务
sudo systemctl start property-erp

# 5. 验证数据
```

### 紧急联系

如遇无法解决的数据问题：
1. 立即停止服务，防止进一步损坏
2. 保留所有日志和错误信息
3. 联系技术支持

---

## 八、自动备份机制说明

系统已内置自动备份机制：

| 备份类型 | 触发时机 | 保存位置 |
|----------|----------|----------|
| 每日自动备份 | 每日首次登录 | `backups/property_erp_YYYYMMDD.db` |
| 手动备份 | 管理员操作 | `backups/property_erp_backup_*.db` |

**备份保留策略**：建议保留最近30天的备份文件。

---

## 九、常见问题

### Q1：修改代码后服务启动失败怎么办？

A：
1. 查看错误日志：`journalctl -u property-erp -n 100`
2. 检查代码语法错误
3. 如无法修复，恢复之前的代码版本
4. 重启服务

### Q2：数据库文件损坏怎么办？

A：
1. 停止服务
2. 从最近的备份恢复
3. 启动服务
4. 检查恢复后的数据完整性

### Q3：如何确认数据没有丢失？

A：
1. 对比更改前后的数据量
2. 抽查几条关键记录
3. 运行三方核对功能
4. 检查审计日志

### Q4：可以同时修改多个文件吗？

A：可以，但建议：
1. 一次只修改相关联的文件
2. 每次修改后都测试
3. 保持修改的原子性

---

## 十、总结

**核心原则：**

1. **备份优先**：任何更改前都要备份
2. **数据分离**：代码和数据是分开的，修改代码不会自动影响数据
3. **谨慎操作**：涉及数据库结构的更改需要特别小心
4. **验证确认**：每次更改后都要验证数据完整性

**记住**：只要不删除数据库文件、不重建表结构，你的数据就是安全的。

---

*文档版本：1.0*  
*更新日期：2026-01-14*  
*适用系统版本：1.7.1*
